#%Module

set moduledir [file dirname $ModulesCurrentModulefile]
set SPACK_CSCS_CONFIGS_ROOT "$moduledir/../../generated-configs"

prereq cray
prereq cpe cpe-cuda

set loaded_mods [split $::env(LOADEDMODULES) :]
set cpe_mod [lsearch -inline $loaded_mods cpe*]
set cpe_name [string map {/ -} $cpe_mod]

set SPACK_CPE_CONFIG_ROOT "$SPACK_CSCS_CONFIGS_ROOT/$cpe_name"

if { [file exists $SPACK_CPE_CONFIG_ROOT] == 1 } {
  setenv SPACK_SYSTEM_CONFIG_PATH "$SPACK_CPE_CONFIG_ROOT"
} else {
  puts stderr "$SPACK_CPE_CONFIG_ROOT does not exist"
  exit 1
}
