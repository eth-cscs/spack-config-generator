#%Module

# Requirements
prereq cray
prereq cpe cpe-cuda
# TODO check that a spack instance is actually available

# Where the generator is installed
set SPACK_CONFIG_GENERATOR_ROOT 	"~/spack-config-generator"
# Where the on-the-fly generated configuration will be stored
set SPACK_CPE_CONFIG_ROOT 		"~/.config/spack-config-generator"

# Cleanup
exec rm -rf $SPACK_CPE_CONFIG_ROOT/*

# Generate new one
exec $SPACK_CONFIG_GENERATOR_ROOT/spack-allinone.py --current-cpe --output-folder $SPACK_CPE_CONFIG_ROOT > $SPACK_CPE_CONFIG_ROOT/output.log

# Setup spack
setenv SPACK_SYSTEM_CONFIG_PATH "$SPACK_CPE_CONFIG_ROOT"
